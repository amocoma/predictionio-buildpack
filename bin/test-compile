#!/bin/bash

# Fail immediately on non-zero exit code.
set -e

BUILD_DIR=${1:-}
random_part=`ruby -r securerandom -e "STDOUT << SecureRandom.hex(4)"`
RANDOM_BUILD_DIR=/tmp/build_for_ci_$random_part
JAVA_HOME=$RANDOM_BUILD_DIR/.jdk
PATH=$RANDOM_BUILD_DIR/.jdk/bin:$PATH

echo "       Mock build directory is $RANDOM_BUILD_DIR"
echo "       Current env:"
echo `env`

mkdir -p $RANDOM_BUILD_DIR
mv $BUILD_DIR/* $BUILD_DIR/.[!.]* $RANDOM_BUILD_DIR/

# Run the main compile script.
eval "bin/compile $RANDOM_BUILD_DIR $2 $3"

mv $RANDOM_BUILD_DIR/* $RANDOM_BUILD_DIR/.[!.]* $BUILD_DIR/
